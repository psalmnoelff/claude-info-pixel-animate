// Bitmap font renderer for in-canvas text
// Uses a minimal 4x6 pixel font
class PixelFont {
  static CHAR_W = 4;
  static CHAR_H = 6;
  static SPACING = 1;

  // 4x6 font glyphs - each character is a 4x6 array of 0/1
  static GLYPHS = {
    'A': [0,1,1,0, 1,0,0,1, 1,1,1,1, 1,0,0,1, 1,0,0,1, 0,0,0,0],
    'B': [1,1,1,0, 1,0,0,1, 1,1,1,0, 1,0,0,1, 1,1,1,0, 0,0,0,0],
    'C': [0,1,1,0, 1,0,0,1, 1,0,0,0, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    'D': [1,1,1,0, 1,0,0,1, 1,0,0,1, 1,0,0,1, 1,1,1,0, 0,0,0,0],
    'E': [1,1,1,1, 1,0,0,0, 1,1,1,0, 1,0,0,0, 1,1,1,1, 0,0,0,0],
    'F': [1,1,1,1, 1,0,0,0, 1,1,1,0, 1,0,0,0, 1,0,0,0, 0,0,0,0],
    'G': [0,1,1,0, 1,0,0,0, 1,0,1,1, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    'H': [1,0,0,1, 1,0,0,1, 1,1,1,1, 1,0,0,1, 1,0,0,1, 0,0,0,0],
    'I': [0,1,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,1,1,0, 0,0,0,0],
    'J': [0,0,1,1, 0,0,0,1, 0,0,0,1, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    'K': [1,0,0,1, 1,0,1,0, 1,1,0,0, 1,0,1,0, 1,0,0,1, 0,0,0,0],
    'L': [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0, 1,1,1,1, 0,0,0,0],
    'M': [1,0,0,1, 1,1,1,1, 1,0,0,1, 1,0,0,1, 1,0,0,1, 0,0,0,0],
    'N': [1,0,0,1, 1,1,0,1, 1,0,1,1, 1,0,0,1, 1,0,0,1, 0,0,0,0],
    'O': [0,1,1,0, 1,0,0,1, 1,0,0,1, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    'P': [1,1,1,0, 1,0,0,1, 1,1,1,0, 1,0,0,0, 1,0,0,0, 0,0,0,0],
    'Q': [0,1,1,0, 1,0,0,1, 1,0,0,1, 1,0,1,0, 0,1,0,1, 0,0,0,0],
    'R': [1,1,1,0, 1,0,0,1, 1,1,1,0, 1,0,1,0, 1,0,0,1, 0,0,0,0],
    'S': [0,1,1,1, 1,0,0,0, 0,1,1,0, 0,0,0,1, 1,1,1,0, 0,0,0,0],
    'T': [1,1,1,1, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,0,0],
    'U': [1,0,0,1, 1,0,0,1, 1,0,0,1, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    'V': [1,0,0,1, 1,0,0,1, 1,0,0,1, 0,1,1,0, 0,0,1,0, 0,0,0,0],
    'W': [1,0,0,1, 1,0,0,1, 1,0,0,1, 1,1,1,1, 1,0,0,1, 0,0,0,0],
    'X': [1,0,0,1, 0,1,1,0, 0,0,0,0, 0,1,1,0, 1,0,0,1, 0,0,0,0],
    'Y': [1,0,0,1, 0,1,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,0,0],
    'Z': [1,1,1,1, 0,0,1,0, 0,1,0,0, 1,0,0,0, 1,1,1,1, 0,0,0,0],
    '0': [0,1,1,0, 1,0,1,1, 1,0,0,1, 1,1,0,1, 0,1,1,0, 0,0,0,0],
    '1': [0,0,1,0, 0,1,1,0, 0,0,1,0, 0,0,1,0, 0,1,1,1, 0,0,0,0],
    '2': [0,1,1,0, 1,0,0,1, 0,0,1,0, 0,1,0,0, 1,1,1,1, 0,0,0,0],
    '3': [1,1,1,0, 0,0,0,1, 0,1,1,0, 0,0,0,1, 1,1,1,0, 0,0,0,0],
    '4': [1,0,0,1, 1,0,0,1, 1,1,1,1, 0,0,0,1, 0,0,0,1, 0,0,0,0],
    '5': [1,1,1,1, 1,0,0,0, 1,1,1,0, 0,0,0,1, 1,1,1,0, 0,0,0,0],
    '6': [0,1,1,0, 1,0,0,0, 1,1,1,0, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    '7': [1,1,1,1, 0,0,0,1, 0,0,1,0, 0,1,0,0, 0,1,0,0, 0,0,0,0],
    '8': [0,1,1,0, 1,0,0,1, 0,1,1,0, 1,0,0,1, 0,1,1,0, 0,0,0,0],
    '9': [0,1,1,0, 1,0,0,1, 0,1,1,1, 0,0,0,1, 0,1,1,0, 0,0,0,0],
    ' ': [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
    ':': [0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,0,0],
    '/': [0,0,0,1, 0,0,1,0, 0,0,1,0, 0,1,0,0, 1,0,0,0, 0,0,0,0],
    '%': [1,0,0,1, 0,0,1,0, 0,1,0,0, 1,0,0,1, 0,0,0,0, 0,0,0,0],
    '.': [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,1,0, 0,0,0,0],
    '-': [0,0,0,0, 0,0,0,0, 1,1,1,1, 0,0,0,0, 0,0,0,0, 0,0,0,0],
    '+': [0,0,0,0, 0,0,1,0, 0,1,1,1, 0,0,1,0, 0,0,0,0, 0,0,0,0],
    '(': [0,0,1,0, 0,1,0,0, 0,1,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,0],
    ')': [0,1,0,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,1,0,0, 0,0,0,0],
    ',': [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,1,0, 0,1,0,0, 0,0,0,0],
    '!': [0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0],
    '?': [0,1,1,0, 1,0,0,1, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0],
    '>': [1,0,0,0, 0,1,0,0, 0,0,1,0, 0,1,0,0, 1,0,0,0, 0,0,0,0],
    'K': [1,0,0,1, 1,0,1,0, 1,1,0,0, 1,0,1,0, 1,0,0,1, 0,0,0,0],
    'k': [1,0,0,1, 1,0,1,0, 1,1,0,0, 1,0,1,0, 1,0,0,1, 0,0,0,0],
  };

  // Draw text at pixel position
  static draw(renderer, text, x, y, colorIndex) {
    const str = text.toUpperCase();
    let cx = Math.floor(x);
    const cy = Math.floor(y);
    const color = CONFIG.PALETTE[colorIndex];

    const bufCtx = renderer.getBufferContext();
    bufCtx.fillStyle = color;

    for (let c = 0; c < str.length; c++) {
      const glyph = PixelFont.GLYPHS[str[c]];
      if (glyph) {
        for (let i = 0; i < glyph.length; i++) {
          if (glyph[i]) {
            const gx = i % PixelFont.CHAR_W;
            const gy = Math.floor(i / PixelFont.CHAR_W);
            bufCtx.fillRect(cx + gx, cy + gy, 1, 1);
          }
        }
      }
      cx += PixelFont.CHAR_W + PixelFont.SPACING;
    }
  }

  // Measure text width in pixels
  static measure(text) {
    return text.length * (PixelFont.CHAR_W + PixelFont.SPACING) - PixelFont.SPACING;
  }
}
